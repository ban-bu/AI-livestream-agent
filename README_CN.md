# 直播电商多智能体模拟系统

## 系统架构
采用三层架构设计：
1. **数据层**：维护商品/商家/主播基础数据
2. 决策层：包含消费者/主播/商家智能体
3. 模拟层：驱动仿真时钟和事件循环

## 核心模块

### 消费者智能体 (consumer_agent.py)
- 决策因素：价格敏感度(0-1)、信任阈值、冲动因子
- 购买公式：`购买概率 = (主播信誉 * 折扣力度) / (价格敏感度 * 原价)`
- 信任更新机制：基于历史退货率动态调整

### 主播智能体 (streamer_agent.py)
- 选品策略：
  - 头部主播：高GMV商品优先
  - 腰部主播：平衡佣金率与转化率
- 话术生成：LSTM模型动态生成促销文案

### 商家智能体 (merchant_agent.py)
- 动态定价算法：`新价格 = 原价 × (1 - 库存压力系数 × 0.1)`
- 库存预警：当库存低于周均销量2倍时触发补货

## 数据流向
1. 初始化加载商品池（product_pool.json）
2. 模拟器生成每日直播事件
3. 智能体通过gRPC接口进行决策交互
4. 决策结果写入MongoDB
5. 数据处理器生成实时GMV仪表盘

## 关键参数
```python
# config.py
SIMULATION_DAYS = 30  # 模拟周期
CONSUMER_GROUPS = [
    {"name": "高端", "size": 5000, "budget": 8000},
    {"name": "中端", "size": 20000, "budget": 3000},
    {"name": "大众", "size": 50000, "budget": 1000}
]
LIVE_ROOM_CAPACITY = {
    "头部主播": 1000000,
    "腰部主播": 300000,
    "新锐主播": 50000
}
```

## 运行逻辑

### 1. 消费者决策树验证流程
- **三阶段验证机制**：
  1. **价格校验阶段**：比对商品历史价格波动区间，过滤超出承受阈值的商品
  2. **信任评估阶段**：基于主播历史退货率（≤5%为高信用）和商品好评率（≥95%为优质）构建信任分数
  3. **冲动决策阶段**：结合实时在线人数（>1万触发抢购氛围）和剩余库存百分比（<30%触发稀缺提示）计算冲动因子

### 2. 主播选品策略
- **GMV预测模型**：
  - 输入参数：商品基础佣金率、历史15分钟转化率、品类搜索热度指数
  - 动态权重：大促期间流量质量系数（1.2-1.5）、时段匹配度（黄金时段加权1.3）
  - 淘汰机制：连续3次转化率低于品类均值80%的商品自动下架

### 3. 商家动态定价
- **库存压力系数**：
  ```
  压力系数 = (当前库存 - 安全库存) / 周均销量
  当系数 > 2.0时触发阶梯降价，每0.5系数区间对应3%价格调整幅度
  安全库存 = 最近7天销量标准差 × 2.5
  ```

### 4. 实时数据聚合
- **窗口滑动机制**：
  - 15分钟窗口按5秒步长滑动更新，保留12个重叠窗口用于异常检测
  - 流量突增预警：连续3个窗口GMV增长率超过50%触发流量校验
  - 数据持久化：每小时执行窗口合并，生成T+1基准指标

### 5. 系统协同机制
- 决策层每5分钟同步市场热度指数到数据层
- 模拟层通过事件总线广播库存变更事件，触发智能体策略更新
- 可视化层订阅聚合后的窗口数据，支持多维度下钻分析

## 数据可视化
- 实时GMV曲线（15分钟粒度）
- 品类销售占比饼图
- 主播效能雷达图（转化率/退货率/佣金收益）

## 扩展接口
```python
# 自定义策略接入
class CustomStrategy(Strategy):
    def calculate_discount(self, product):
        # 实现自定义折扣算法
        return super().calculate_discount()
```

## 系统协同机制

### 1. 消费者购买触发实时更新
- **事件格式**：
  ```json
  {
    "event_type": "purchase",
    "streamer_id": "主播ID",
    "product_id": "商品ID",
    "gmv": 成交金额,
    "timestamp": "时间戳"
  }
  ```
- **处理逻辑**：
  1. 主播效能指标（转化率/GMV）60秒内自动刷新
  2. 平台风控系统实时计算异常购买模式

### 2. 库存事件广播
- **消息结构**：
  ```protobuf
  message InventoryUpdate {
    required string merchant_id = 1;
    map<string, int32> stock_changes = 2; // 商品ID:库存变化量
    optional double price_adjustment = 3; // 价格调整幅度
  }
  ```
- **订阅机制**：
  - 主播Agent：当竞品库存增加>20%时触发选品策略重评估
  - 平台Agent：监控品类级库存波动

### 3. 结算对账流程
1. **每日21:00自动生成结算清单**
   - 主播维度佣金汇总
   - 商家维度技术服务费
2. **异常处理**：
   - 金额偏差>0.5%触发人工复核
   - 连续3天差异自动冻结账户
3. **跨平台核对**：
   ```python
   # 对账核心逻辑
   def reconcile(payment, order):
       if abs(payment['amount'] - order['amount']) > EPSILON:
           create_alert('AMOUNT_MISMATCH', payment, order)
       if payment['status'] != order['status']:
           create_alert('STATUS_DISCREPANCY', payment, order)
   ```